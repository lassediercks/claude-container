#!/bin/bash

# Claude Code Container Utility
# A portable Docker-based Claude Code environment

VERSION="0.0.1"
IMAGE_NAME="claude-container:latest"
CONTAINER_NAME="claude-container-$(date +%s)"

# Handle version command
if [ "$1" = "version" ] || [ "$1" = "--version" ] || [ "$1" = "-v" ]; then
    echo "claude-container version $VERSION"
    exit 0
fi

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "Error: Docker is not running or not accessible"
    exit 1
fi

# Check if image exists, if not prompt to build
if ! docker image inspect "$IMAGE_NAME" > /dev/null 2>&1; then
    echo "Image '$IMAGE_NAME' not found."
    echo "Please build the image first with:"
    echo "  docker build -f Dockerfile.utility -t $IMAGE_NAME ."
    exit 1
fi

# Get current directory
CURRENT_DIR="$(pwd)"

# Check if ~/.claude.json exists and mount it read-write
CLAUDE_JSON_MOUNT=""
if [ -f "$HOME/.claude.json" ]; then
    CLAUDE_JSON_MOUNT="-v $HOME/.claude.json:/root/.claude.json"
fi

# Cleanup function
cleanup() {
    docker stop "$CONTAINER_NAME" 2>/dev/null || true
}

# Set trap for cleanup on exit
trap cleanup EXIT INT TERM

# Run the container with current directory mounted
docker run -it --rm \
    --init \
    --name "$CONTAINER_NAME" \
    -v "$CURRENT_DIR:/workspace" \
    $CLAUDE_JSON_MOUNT \
    -w /workspace \
    -e TERM="xterm-256color" \
    -e COLORTERM="truecolor" \
    "$IMAGE_NAME" \
    bash

exit $?